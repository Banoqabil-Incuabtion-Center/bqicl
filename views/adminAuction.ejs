<%- include('layouts/admin_layout_header', { title: 'Auction Control' , hideNavbar: true, hideHeader: true }) %>

<div class="px-8 py-6 max-w-7xl mx-auto w-full">
    <div class="mb-8 relative z-50">
        <a href="/admin/dashboard"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-gray-800/50 hover:bg-blue-600 text-white transition-all font-black uppercase text-[10px] tracking-widest group border border-white/10">
            <i class="fas fa-chevron-left group-hover:-translate-x-1 transition-transform"></i>
            Back to Dashboard
        </a>
    </div>

    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <div id="session-controls-top" class="mb-6 flex justify-end">
        <% if (!isSessionActive) { %>
            <button onclick="initSession()" id="init-btn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-bold text-sm transition-all text-white shadow-lg shadow-blue-500/20">
                <i class="fas fa-play mr-2"></i> Start Session
            </button>
        <% } else { %>
            <div class="flex items-center gap-3">
                <span class="flex h-3 w-3 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-green-400 font-bold uppercase text-[10px] tracking-widest">Live Session Active</span>
                <button onclick="endSession()" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-1.5 rounded-lg text-[10px] font-bold">
                    End Session
                </button>
            </div>
        <% } %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-xl flex flex-col h-[750px]">
            
           <div class="p-5 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-900/20">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-gray-500 dark:text-gray-400 text-[10px] font-black uppercase tracking-widest">Available Players</h3>
        <span id="playerCount" class="text-[10px] bg-blue-500/10 text-blue-500 px-2 py-0.5 rounded-full font-bold"></span>
    </div>

    <div class="mb-3">
    <div class="relative flex gap-2">
        <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]"></i>
            <input type="text" id="nameSearch" 
                value="<%= query.search || '' %>"
                placeholder="Search name..." 
                <%= activeAuction ? 'disabled' : '' %> 
                class="w-full bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-[11px] font-bold py-2 pl-8 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white disabled:opacity-50">
        </div>
        <button <%= activeAuction ? 'disabled' : '' %>  onclick="applyFilters()" class=" px-4 rounded-lg text-white text-[10px] font-bold <%= activeAuction ? 'bg-blue-600/50 cursor-pointer' : 'bg-blue-600 hover:bg-blue-700' %>    transition-colors "  >GO</button>
        
        <button <%= activeAuction ? 'disabled' : '' %>   onclick="window.location.href='/admin/auction'" 
    class=" px-3 rounded-lg <%= activeAuction ? 'bg-gray-600/50 cursor-pointer' : 'bg-gray-600/50 hover:bg-gray-600' %>  text-white text-[10px] font-bold transition-all">
    RESET
</button>
    </div>
</div>





<div class="grid grid-cols-2 gap-2">
    <select id="catFilter" onchange="applyFilters()" <%= activeAuction ? 'disabled' : '' %> 
        class="bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-[11px] font-bold py-2 focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
        <option value="all">All Tiers</option>
        <option value="Platinum" <%= query.category === 'Platinum' ? 'selected' : '' %>>Platinum</option>
        <option value="Diamond" <%= query.category === 'Diamond' ? 'selected' : '' %>>Diamond</option>
        <option value="Gold" <%= query.category === 'Gold' ? 'selected' : '' %>>Gold</option>
        <option value="Silver" <%= query.category === 'Silver' ? 'selected' : '' %>>Silver</option>
    </select>
    
    <select id="roleFilter" onchange="applyFilters()" <%= activeAuction ? 'disabled' : '' %>
        class="bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-[11px] font-bold py-2 focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
        <option value="all">All Roles</option>
        <option value="Batsman" <%= query.role === 'Batsman' ? 'selected' : '' %>>Batsman</option>
        <option value="Bowler" <%= query.role === 'Bowler' ? 'selected' : '' %>>Bowler</option>
        <option value="All-rounder" <%= query.role === 'All-rounder' ? 'selected' : '' %>>All Rounder</option>
        <option value="Wicket-keeper-batsman" <%= query.role === 'Wicket-keeper-batsman' ? 'selected' : '' %>>Wicket keeper</option>
    </select>
</div>

    
    
    <% if(activeAuction) { %>
        <div class="mt-2 text-center"><span class="text-[9px] text-amber-500 font-black uppercase italic">Filters locked during call</span></div>
    <% } %>
</div>

            <div id="playersList" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <% 
                    const priority = { 'Platinum': 1, 'Diamond': 2, 'Gold': 3, 'Silver': 4 };
                    const sortedPlayers = players.sort((a, b) => (priority[a.auctionCategory] || 99) - (priority[b.auctionCategory] || 99));

                    const getCatStyle = (cat) => {
                        const c = (cat || '').toLowerCase();
                        if(c === 'platinum') return 'bg-indigo-50 dark:bg-indigo-950/30 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300';
                        if(c === 'diamond') return 'bg-amber-50 dark:bg-amber-950/30 border-amber-200 dark:border-amber-800 text-amber-700 dark:text-amber-300';
                        if(c === 'gold') return 'bg-slate-50 dark:bg-slate-800/40 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300';
                        if(c === 'silver') return 'bg-orange-50 dark:bg-orange-950/20 border-orange-200 dark:border-orange-800 text-orange-700 dark:text-orange-300';
                        return 'bg-gray-50 dark:bg-gray-700/30 border-gray-100 dark:border-gray-600';
                    };
                %>

                <% if (sortedPlayers.length > 0) { %>
                
                <% sortedPlayers.forEach(player=> { %>
                    <div class="player-card flex items-center justify-between p-3 rounded-xl border transition-all hover:scale-[1.02] <%= getCatStyle(player.auctionCategory) %>"
                         data-category="<%= player.auctionCategory %>" 
                         data-role="<%= player.category %>">
                        <div class="flex items-center gap-3">
                            <div class="h-11 w-11 rounded-full bg-gray-200 dark:bg-gray-600 overflow-hidden ring-2 ring-white/50 dark:ring-black/20 shadow-sm">
                                <img src="<%= player.playerImage %>" class="object-cover h-full w-full" alt="Player">
                            </div>
                            <div class="min-w-0">
                                <p class="text-[13px] font-black truncate text-gray-900 dark:text-white uppercase leading-tight"><%= player.name %></p>
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    <span class="text-[9px] font-black uppercase opacity-80"><%= player.auctionCategory %></span>
                                    <span class="text-[9px] font-bold text-blue-500 uppercase tracking-tighter">• <%= player.category %></span>
                                </div>
                            </div>
                        </div>
                        <button onclick="pushToAuction('<%= player.id %>')"
                            class="<%= isSessionActive && !activeAuction ? 'bg-blue-600 hover:bg-blue-700 text-white shadow-md' : 'bg-gray-300 text-gray-500 cursor-not-allowed shadow-none' %> px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all"
                            <%=(!isSessionActive || activeAuction) ? 'disabled' : '' %>>
                            Call
                        </button>
                    </div>
                <% }) %>
    <% } else { %>
        <div class="flex flex-col items-center justify-center h-full text-center p-6 animate-in fade-in duration-500">
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-user-slash text-gray-400 text-xl"></i>
            </div>
            <p class="text-gray-900 dark:text-white font-black uppercase text-[12px] tracking-widest">No Players Found</p>
            <p class="text-gray-500 text-[10px] mt-2 mb-6 uppercase font-bold">Try changing your search or filters</p>
            
            <button onclick="window.location.href='/admin/auction'" 
                class="bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-black uppercase tracking-widest px-6 py-2.5 rounded-lg transition-all shadow-lg shadow-blue-500/20">
                <i class="fas fa-undo mr-2"></i> Reset Filters
            </button>
        </div>
    <% } %>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div id="main-display-area" class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 p-8 min-h-[600px] flex flex-col justify-center items-center text-center relative overflow-hidden shadow-xl">
                <% if (!isSessionActive) { %>
                    <div class="animate-in fade-in duration-500">
                        <div class="h-24 w-24 bg-gray-100 dark:bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-power-off text-4xl text-gray-400"></i>
                        </div>
                        <h2 class="text-2xl font-black text-gray-400 uppercase tracking-tighter">System Offline</h2>
                    </div>
                <% } else if (!activeAuction) { %>
                    <div class="animate-in zoom-in-95 duration-500">
                        <i class="fas fa-hourglass-start text-6xl text-blue-500 animate-spin-slow mb-6"></i>
                        <h2 class="text-2xl font-black text-gray-900 dark:text-white uppercase tracking-widest">Select a Player</h2>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-3">Ready to begin the bidding process</p>
                    </div>
                <% } else { %>
                    <div class="w-full animate-in slide-in-from-bottom-4 duration-500">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-12">
                            <div class="text-center md:text-left">
                                <span class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-500 text-[10px] font-black uppercase tracking-widest mb-4">Currently Bidding</span>
                                <h2 class="text-5xl font-black text-gray-900 dark:text-white uppercase"><%= activeAuction.currentPlayer.name %></h2>
                                <p class="text-blue-500 font-bold uppercase tracking-widest text-sm mt-2"><%= activeAuction.currentPlayer.auctionCategory %> • <%= activeAuction.currentPlayer.category %></p>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-900/50 px-10 py-8 rounded-3xl border border-gray-200 dark:border-gray-700 min-w-[280px]">
                                <p class="text-gray-400 text-[10px] font-black uppercase mb-2 tracking-widest">Current Bid</p>
                                <p class="text-7xl font-black text-green-500">$<%= activeAuction.currentBid %></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <button id="markSoldBtn" onclick="markSold()" 
                                class="py-5 rounded-2xl font-black text-2xl transition-all <%= activeAuction.lastBidTeamId ? 'bg-green-500 text-white shadow-lg shadow-green-500/20 active:scale-95' : 'bg-gray-300 dark:bg-gray-700 text-gray-500 cursor-not-allowed' %>" 
                                <%=!activeAuction.lastBidTeamId ? 'disabled' : '' %>>SOLD</button>
                            <button onclick="markUnsold()" class="bg-red-500/10 text-red-500 border-2 border-red-500/20 py-5 rounded-2xl font-black text-2xl hover:bg-red-500 hover:text-white transition-all active:scale-95">UNSOLD</button>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script>
        // Clean and count players
        function updateCount() {
            const visible = document.querySelectorAll('.player-card[style="display: flex;"]').length;
            const total = document.querySelectorAll('.player-card').length;
            document.getElementById('playerCount').textContent = visible === total ? total : `${visible}/${total}`;
        }

       function applyFilters() {
    const search = document.getElementById('nameSearch').value;
    const auctionCategory = document.getElementById('catFilter').value;
    // const category = document.getElementById('roleFilter').value;

    const params = new URLSearchParams(window.location.search);

    if (search) params.set('search', search); else params.delete('search');
    // if (category !== 'all') params.set('category', category); else params.delete('category');
    if (auctionCategory !== 'all') params.set('auctionCategory', auctionCategory); else params.delete('auctionCategory');

    // Reload page with new query params
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

        // Initialize Pusher
        const pusherKey = "<%= process.env.PUSHER_KEY %>";
        const pusher = new Pusher(pusherKey, { cluster: '<%= process.env.PUSHER_CLUSTER || "ap2" %>' });
        const channel = pusher.subscribe('auction-channel');

        channel.bind('bid-placed', (data) => { location.reload(); });
        channel.bind('new-player', () => location.reload());
        channel.bind('player-sold', () => location.reload());
        channel.bind('player-unsold', () => location.reload());

        async function initSession() { await fetch('/api/auction/session/start', { method: 'POST' }); location.reload(); }
        async function endSession() { 
            showConfirmModal({ title: 'End Auction Session?', message: 'All bidding will be paused.', onConfirm: async () => { await fetch('/api/auction/session/end', { method: 'POST' }); location.reload(); } }); 
        }
        async function pushToAuction(playerId) {
            const res = await fetch('/api/auction/player/call', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ playerId }) });
            const data = await res.json();
            if (data.success) location.reload(); else alert(data.message);
        }
        async function markSold() { showConfirmModal({ title: 'Confirm Player Sold', message: 'This will record the player to the highest bidder.', type: 'success', onConfirm: async () => { await fetch('/api/auction/sold', { method: 'POST' }); } }); }
        async function markUnsold() { showConfirmModal({ title: 'Mark as Unsold?', message: 'Player will return to the pool.', type: 'warning', onConfirm: async () => { await fetch('/api/auction/unsold', { method: 'POST' }); } }); }

        // Initial count
        updateCount();

function applyFilters() {
    // 1. Get the current values from all inputs
    const searchVal = document.getElementById('nameSearch').value.trim();
    const catVal = document.getElementById('catFilter').value;
    const roleVal = document.getElementById('roleFilter').value;

    // 2. Create a new params object
    const params = new URLSearchParams();

    // 3. Append them only if they aren't default/empty
    if (searchVal) {
        params.set('search', searchVal);
    }
    
    if (catVal && catVal !== 'all') {
        params.set('category', catVal);
    }
    
    if (roleVal && roleVal !== 'all') {
        params.set('role', roleVal);
    }

    // 4. Debug: Log to console to see what is happening before redirect
    console.log("Generated Params:", params.toString());

    // 5. Redirect using the full string
    const baseUrl = window.location.pathname;
    const queryString = params.toString();
    
    window.location.href = queryString ? `${baseUrl}?${queryString}` : baseUrl;
}

// Allow pressing "Enter" in the search box to trigger filtering
document.getElementById('nameSearch').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});


    </script>

    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; }
    </style>
</div>

<%- include('partials/confirmModal') %>
<%- include('layouts/admin_layout_footer') %>