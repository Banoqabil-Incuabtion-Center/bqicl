<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Mission Control | AuctionPro</title>
  <link href="/css/output.css" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Pulse Animation */
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(74, 222, 128, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .bid-pulse {
            animation: pulse-green 2s infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }

        /* Mobile Drawer Transition */
        .drawer-enter {
            transform: translateX(0);
        }

        .drawer-exit {
            transform: translateX(-100%);
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans antialiased">
    <div class="flex min-h-screen md:h-screen">
        <%- include('partials/adminNavbar') %>
        <div class="flex-1 flex flex-col min-h-screen md:overflow-hidden">
            <header
                class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 md:px-8 shrink-0">
                <div class="flex items-center gap-4">
                    <button class="mobile-toggle p-2 text-gray-400 hover:text-white md:hidden">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-lg md:text-xl font-bold truncate">Auction Control</h2>
                </div>

                <div id="session-controls" class="flex items-center gap-3">
                    <% if (!isSessionActive) { %>
                        <button onclick="initSession()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/50 transition-all active:scale-95 whitespace-nowrap">
                            <i class="fas fa-play mr-1"></i> Start Session
                        </button>
                    <% } else { %>
                        <div
                            class="flex items-center gap-2 px-3 py-1 rounded-full bg-green-900/30 border border-green-500/30">
                            <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-green-400 text-xs font-bold uppercase tracking-wider">Live</span>
                        </div>
                        <button onclick="endSession()"
                            class="text-red-400 hover:text-red-300 text-xs font-medium border border-red-500/30 px-3 py-1 rounded hover:bg-red-500/10 transition-colors">End</button>
                    <% } %>
                </div>
            </header>

            <main
                class="flex-1 p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8 overflow-y-auto md:overflow-y-auto lg:overflow-hidden">
                <!-- Players List (Mobile: Order 2, Desktop: Order 1) -->
                <div
                    class="order-2 lg:order-1 lg:col-span-1 bg-gray-800 rounded-2xl border border-gray-700 p-4 md:p-6 lg:overflow-y-auto">
                    <h3 class="text-gray-400 text-xs font-bold uppercase mb-4">Available Players</h3>
                    <div class="space-y-3 md:space-y-4">
                        <% players.forEach(player => { %>
                            <div
                                class="flex items-center justify-between p-3 bg-gray-700/30 rounded-xl border border-gray-600 group">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-full bg-gray-600 overflow-hidden shrink-0">
                                        <img src="<%= player.playerImage %>" class="object-cover h-full w-full">
                                    </div>
                                    <div class="min-w-0">
                                        <p class="text-sm font-medium truncate">
                                            <%= player.name %>
                                        </p>
                                        <p class="text-[10px] text-gray-500">Base: $<%= player.basePrice %>
                                        </p>
                                    </div>
                                </div>
                                <button onclick="pushToAuction('<%= player.id %>')"
                                    class="<%= isSessionActive ? 'text-blue-400 hover:text-blue-300' : 'text-gray-600 cursor-not-allowed' %> text-[10px] font-bold uppercase shrink-0"
                                    <%= !isSessionActive ? 'disabled' : '' %>>
                                    Call
                                </button>
                            </div>
                        <% }) %>
                    </div>
                </div>

                <!-- Main Display (Mobile: Order 1, Desktop: Order 2) -->
                <div class="order-1 lg:order-2 lg:col-span-2 space-y-4 md:space-y-6">
                    <% if (!isSessionActive) { %>
                        <div id="main-display-area"
                            class="bg-gray-800 rounded-3xl border border-gray-700 p-6 md:p-8 min-h-[400px] lg:h-full flex flex-col justify-center items-center text-center relative overflow-hidden">

                            <!-- Background Decoration for Mobile -->
                            <div class="absolute top-0 right-0 p-8 opacity-5 md:hidden">
                                <i class="fas fa-gavel text-6xl"></i>
                            </div>

                            <div id="state-no-session">
                                <i class="fas fa-power-off text-5xl md:text-6xl text-gray-700 mb-4"></i>
                                <h2 class="text-xl md:text-2xl font-bold text-gray-500">System Offline</h2>
                                <p class="text-gray-600 text-sm max-w-xs mx-auto mt-2">Initialize the global session
                                    to enable bidding.</p>
                            </div>
                        </div>
                    <% } else if (activeAuction) { %>
                        <div
                            class="lg:col-span-6 flex flex-col h-full overflow-y-auto bg-gray-900 lg:bg-gray-800 lg:rounded-2xl lg:border lg:border-gray-700 p-6 relative">
                            <div class="absolute top-6 right-6">
                                <span
                                    class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest border border-gray-600 text-gray-300 bg-gray-900">
                                    <%= activeAuction.currentPlayer.auctionCategory %> Tier
                                </span>
                            </div>

                            <div class="mt-4 flex flex-col items-center text-center lg:items-start lg:text-left">
                                <div
                                    class="h-48 w-48 rounded-2xl bg-gray-700 border-4 border-gray-600 overflow-hidden shadow-2xl mb-6">
                                    <img src="<%= activeAuction.currentPlayer.playerImage || '/images/default-player.png' %>"
                                        class="h-full w-full object-cover">
                                </div>

                                <h1 class="text-4xl lg:text-6xl font-black text-white leading-tight mb-2">
                                    <%= activeAuction.currentPlayer.name %>
                                </h1>
                                <p class="text-xl text-blue-400 font-medium mb-8">
                                    <%= activeAuction.currentPlayer.category %>
                                </p>

                                <div class="grid grid-cols-2 gap-4 w-full">
                                    <div class="bg-gray-800 lg:bg-gray-900 p-4 rounded-xl border border-gray-700">
                                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">
                                            Base Price</p>
                                        <p class="text-2xl font-bold text-white">$<%=
                                                activeAuction.currentPlayer.basePrice.toLocaleString() %>
                                        </p>
                                    </div>
                                    <div class="bg-gray-800 lg:bg-gray-900 p-4 rounded-xl border border-gray-700">
                                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">
                                            Batting Style</p>
                                        <p class="text-lg font-semibold text-gray-300">
                                            <%= activeAuction.currentPlayer.playingStyle %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            class="lg:col-span-3 flex flex-col h-full bg-gray-900 border-t lg:border-t-0 lg:border-l border-gray-800 lg:bg-gray-800 lg:rounded-2xl lg:border lg:border-gray-700 shadow-2xl relative z-20">

                            <div class="flex-1 flex flex-col items-center justify-center p-6">
                                <p class="text-green-500 text-xs font-bold uppercase tracking-widest mb-4">
                                    Current High Bid</p>
                                <div
                                    class="bg-gray-800 lg:bg-gray-900 w-full py-8 rounded-2xl border border-gray-700 text-center mb-6">
                                    <h2 class="text-5xl font-black text-white tracking-tighter"
                                        id="current-bid-display">
                                        <span class="text-green-600 text-3xl align-top">$</span>
                                        <%= activeAuction.currentBid.toLocaleString() %>
                                    </h2>
                                </div>

                                <div id="bidder-info" class="w-full flex justify-center min-h-[40px]">
                                    <% if(activeAuction.currentHighestBidder) { %>
                                        <div
                                            class="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full border border-gray-600 shadow-lg">
                                            <span
                                                class="h-2 w-2 shrink-0 bg-green-500 rounded-full animate-pulse"></span>
                                            <span class="text-xs text-gray-300">Held by: <strong class="text-white">
                                                    <%= activeAuction.currentHighestBidder.name %>
                                                </strong></span>
                                        </div>
                                    <% } else { %>
                                        <span class="text-xs text-gray-500 italic">Waiting for opening
                                            bid...</span>
                                    <% } %>
                                </div>
                            </div>

                            <div class="p-4 grid grid-cols-2 gap-3 border-t border-gray-700 bg-gray-800/50">
                                <button id="btn-sold" onclick="markSold()"
                                    class="text-white font-black py-5 rounded-xl shadow-xl transform active:scale-95 transition-all text-xl flex flex-col items-center justify-center
                                    <%= activeAuction.currentHighestBidder ? 'bg-green-600 hover:bg-green-500 cursor-pointer' : 'bg-gray-700 opacity-50 cursor-not-allowed' %>"
                                    <%= !activeAuction.currentHighestBidder ? 'disabled' : '' %>>
                                    <span>SOLD</span>
                                </button>

                                <button onclick="markUnsold()"
                                    class="bg-gray-700 hover:bg-red-900/40 text-gray-400 hover:text-red-400 border border-gray-600 hover:border-red-500/50 font-bold py-5 rounded-xl transform active:scale-95 transition-all text-xl flex flex-col items-center justify-center">
                                    <span>UNSOLD</span>
                                </button>
                            </div>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sidebar Toggle for Mobile
        function toggleDraftPool() {
            const el = document.getElementById('draft-pool-sidebar');
            const overlay = document.getElementById('draft-overlay');
            if (el.classList.contains('-translate-x-full')) {
                el.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                el.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // --- PUSHER & API LOGIC ---
        const pusherKey = "<%= process.env.PUSHER_KEY %>";
        const pusher = new Pusher(pusherKey, { cluster: '<%= process.env.PUSHER_CLUSTER || "ap2" %>' });
        const channel = pusher.subscribe('auction-channel');

        const myTeamId = null;

        channel.bind('bid-placed', (data) => {
            const bidDisplay = document.getElementById('current-bid-display');
            if (bidDisplay) {
                bidDisplay.innerHTML = `<span class="text-green-600 text-3xl align-top">$</span>${Number(data.amount).toLocaleString()}`;
                bidDisplay.parentElement.classList.add('bid-pulse');
                setTimeout(() => bidDisplay.parentElement.classList.remove('bid-pulse'), 1000);
            }
            pollState();
        });

        channel.bind('new-player', () => location.reload());
        channel.bind('player-sold', (data) => {
            showSoldScreen(data);
        });
        channel.bind('player-unsold', () => location.reload());

        async function initSession() {
            try {
                await fetch('/api/auction/session/start', { method: 'POST' });
                location.reload();
            } catch (e) {
                console.error("Session start failed", e);
            }
        }

        async function endSession() {
            if (confirm('End Session?')) {
                try {
                    await fetch('/api/auction/session/end', { method: 'POST' });
                    location.reload();
                } catch (e) {
                    console.error("Session end failed", e);
                }
            }
        }

        async function pushToAuction(playerId) {
            try {
                await fetch('/api/auction/player/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId })
                });
            } catch (e) {
                console.error("Player push failed", e);
            }
        }

        async function markSold() {
            if (confirm('Confirm Sale?')) {
                try {
                    await fetch('/api/auction/sold', { method: 'POST' });
                } catch (e) {
                    console.error("Mark sold failed", e);
                }
            }
        }

        async function markUnsold() {
            if (confirm('Mark Unsold?')) {
                try {
                    await fetch('/api/auction/unsold', { method: 'POST' });
                } catch (e) {
                    console.error("Mark unsold failed", e);
                }
            }
        }

        async function pollState() {
            try {
                const res = await fetch('/api/auction/state');
                const data = await res.json();
                if (data.auction) {
                    const btnSold = document.getElementById('btn-sold');
                    const bidderInfo = document.getElementById('bidder-info');
                    const bidDisplay = document.getElementById('current-bid-display');

                    if (bidDisplay) bidDisplay.innerHTML = `<span class="text-green-600 text-3xl align-top">$</span>${data.auction.currentBid.toLocaleString()}`;

                    if (data.auction.highestBidder) {
                        btnSold.disabled = false;
                        btnSold.classList.remove('bg-gray-700', 'opacity-50', 'cursor-not-allowed');
                        btnSold.classList.add('bg-green-600', 'hover:bg-green-500', 'cursor-pointer');

                        bidderInfo.innerHTML = `
            <div class="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full border border-gray-600 shadow-lg">
                <span class="h-2 w-2 shrink-0 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-xs text-gray-300">Held by: <strong class="text-white">${data.auction.highestBidder.name}</strong></span>
            </div>`;
                    } else {
                        btnSold.disabled = true;
                        btnSold.classList.add('bg-gray-700', 'opacity-50', 'cursor-not-allowed');
                        btnSold.classList.remove('bg-green-600', 'hover:bg-green-500', 'cursor-pointer');
                        bidderInfo.innerHTML = `<span class="text-xs text-gray-500 italic">Waiting for opening bid...</span>`;
                    }
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <div id="sold-overlay"
        class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-black/95 backdrop-blur-xl transition-opacity duration-500 opacity-0">

        <div id="winner-banner" class="hidden mb-8 animate-bounce">
            <h1
                class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-400 tracking-tighter drop-shadow-[0_0_25px_rgba(234,179,8,0.5)]">
                YOU WON!
            </h1>
        </div>

        <div id="sold-banner" class="mb-8">
            <h1
                class="text-6xl md:text-8xl font-black text-white tracking-widest uppercase drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
                SOLD
            </h1>
        </div>

        <div class="relative bg-gray-900 border-2 border-yellow-500/50 p-1 rounded-3xl shadow-[0_0_50px_rgba(234,179,8,0.2)] transform transition-all duration-700 scale-90"
            id="sold-card">
            <div class="bg-[#111827] rounded-2xl p-8 md:p-12 text-center flex flex-col items-center max-w-lg">

                <div
                    class="h-48 w-48 md:h-64 md:w-64 rounded-full border-4 border-yellow-500 overflow-hidden mb-6 shadow-2xl relative">
                    <img id="sold-player-img" src="" class="h-full w-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                </div>

                <h2 id="sold-player-name"
                    class="text-3xl md:text-5xl font-black text-white mb-2 tracking-tight">
                </h2>
                <p id="sold-player-role" class="text-blue-400 font-bold uppercase tracking-widest text-sm mb-6">
                </p>

                <div class="bg-green-900/30 border border-green-500/50 px-8 py-3 rounded-xl mb-6">
                    <p class="text-green-400 text-xs font-bold uppercase mb-1">Sold Price</p>
                    <p id="sold-price" class="text-4xl md:text-5xl font-black text-white"></p>
                </div>

                <div class="flex items-center gap-3 bg-gray-800 px-6 py-3 rounded-full border border-gray-700">
                    <span class="text-gray-400 text-sm uppercase font-bold">Sold To:</span>
                    <span id="sold-team-name" class="text-yellow-400 text-xl font-bold"></span>
                </div>

            </div>
        </div>
    </div>
</body>

</html>
